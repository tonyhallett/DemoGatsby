<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 3.14.0"/><link as="script" rel="preload" href="/DemoGatsby/webpack-runtime-92ea2c36fbfb344b443f.js"/><link as="script" rel="preload" href="/DemoGatsby/framework-33b76a5d919ecf8a8684.js"/><link as="script" rel="preload" href="/DemoGatsby/app-0d7647bce7fd84d9a89d.js"/><link as="script" rel="preload" href="/DemoGatsby/3710c607fb7064fe4fae57fa2457800b9099a42b-828b874f09212eef7e62.js"/><link as="script" rel="preload" href="/DemoGatsby/component---src-pages-deepdive-gatsby-store-cache-js-dbe7ef065c5348ef6a7b.js"/><link as="fetch" rel="preload" href="/DemoGatsby/page-data/deepdive/gatsby/store-cache/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/DemoGatsby/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><main><title>Cache and Redux</title><p>Redux is used for state management in gatsby.  There are really two redux stores, one for reporter logging and the general store.</p><p>The reporter store is created <a href="https://github.com/gatsbyjs/gatsby/blob/a1f35ca37aed1b076f057f1522b56b75a3bdf223/packages/gatsby-cli/src/reporter/redux/index.ts#L10" rel="noreferrer" target="_blank">here</a>.  Note that the reporter actions are bound to the <linkNewTab href="https://github.com/gatsbyjs/gatsby/blob/a1f35ca37aed1b076f057f1522b56b75a3bdf223/packages/gatsby-cli/src/reporter/redux/index.ts#L32" title="dispatch"></linkNewTab> function.</p><p>The <a href="https://github.com/gatsbyjs/gatsby/blob/a1f35ca37aed1b076f057f1522b56b75a3bdf223/packages/gatsby/src/redux/index.ts#L80" rel="noreferrer" target="_blank">main redux store</a> has multiple reducers <b>that include the reporter </b> <a href="https://github.com/gatsbyjs/gatsby/blob/a1f35ca37aed1b076f057f1522b56b75a3bdf223/packages/gatsby/src/redux/reducers/index.ts#L2" rel="noreferrer" target="_blank">logs reducer</a>.  The typescript state can be found <a href="https://github.com/gatsbyjs/gatsby/blob/a1f35ca37aed1b076f057f1522b56b75a3bdf223/packages/gatsby/src/redux/types.ts#L223" rel="noreferrer" target="_blank">here</a>When we gatsby build/develop, very early on we get the following <a href="https://github.com/gatsbyjs/gatsby/blob/a1f35ca37aed1b076f057f1522b56b75a3bdf223/packages/gatsby/src/services/initialize.ts#L100" rel="noreferrer" target="_blank">code</a>.</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code class="language-typescript" style="white-space:pre"><span>
</span><span>  </span><span style="color:#954121">export</span><span> </span><span style="color:#954121">async</span><span> </span><span class="hljs-function" style="color:#954121">function</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#458;font-weight:bold">initialize</span><span class="hljs-function">(</span><span class="hljs-function" style="color:#00f">{
</span><span style="color:#408080;font-style:italic">    program: args,
</span><span style="color:#408080;font-style:italic">    parentSpan,
</span><span class="hljs-function" style="color:#00f">  }: IBuildContext</span><span class="hljs-function">): </span><span class="hljs-function" style="color:#458;font-weight:bold">Promise</span><span class="hljs-function">&lt;</span><span>{
</span><span>    </span><span class="hljs-attr">store</span><span>: Store&lt;IGatsbyState, AnyAction&gt;
</span>    workerPool: WorkerPool.GatsbyWorkerPool
<!-- -->  }&gt; {
<span>    </span><span style="color:#408080;font-style:italic">//....</span><span>
</span>  
<span>    </span><span style="color:#408080;font-style:italic">/* Time for a little story...
</span><span style="color:#408080;font-style:italic">     * When running `gatsby develop`, the globally installed gatsby-cli starts
</span><span style="color:#408080;font-style:italic">     * and sets up a Redux store (which is where logs are now stored). When gatsby
</span><span style="color:#408080;font-style:italic">     * finds your project&#x27;s locally installed gatsby-cli package in node_modules,
</span><span style="color:#408080;font-style:italic">     * it switches over. This instance will have a separate redux store. We need to
</span><span style="color:#408080;font-style:italic">     * ensure that the correct store is used which is why we call setStore
</span><span style="color:#408080;font-style:italic">     * (/packages/gatsby-cli/src/reporter/redux/index.js)
</span><span style="color:#408080;font-style:italic">     *
</span><span style="color:#408080;font-style:italic">     * This function
</span><span style="color:#408080;font-style:italic">     * - copies over the logs from the global gatsby-cli to the local one
</span><span style="color:#408080;font-style:italic">     * - sets the store to the local one (so that further actions dispatched by
</span><span style="color:#408080;font-style:italic">     * the global gatsby-cli are handled by the local one)
</span><span style="color:#408080;font-style:italic">     */</span><span>
</span><span>    </span><span style="color:#954121">if</span><span> (args.setStore) {
</span>      args.setStore(store)
<!-- -->    }
<span>    </span><span style="color:#408080;font-style:italic">//...</span><span>
</span>  }
<!-- -->  
</code></pre><p> The cli passes <a href="https://github.com/gatsbyjs/gatsby/blob/a1f35ca37aed1b076f057f1522b56b75a3bdf223/packages/gatsby-cli/src/reporter/redux/index.ts#L80" rel="noreferrer" target="_blank">setStore</a> <a href="https://github.com/gatsbyjs/gatsby/blob/a1f35ca37aed1b076f057f1522b56b75a3bdf223/packages/gatsby-cli/src/create-cli.ts#L128" rel="noreferrer" target="_blank">in args</a>.</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code class="language-typescript" style="white-space:pre"><span>
</span><span>  </span><span style="color:#408080;font-style:italic">// internally there are no storeSwapListeners added with onStoreSwap.</span><span>
</span><span>  </span><span style="color:#954121">export</span><span> </span><span style="color:#954121">const</span><span> setStore = (s: GatsbyCLIStore): </span><span class="hljs-function" style="color:#00f">void</span><span class="hljs-function"> =&gt;</span><span> {
</span>    s.dispatch({
<span>      </span><span class="hljs-attr">type</span><span>: Actions.SetLogs,
</span><span>      </span><span class="hljs-attr">payload</span><span>: store.getState().logs,
</span><span>    } </span><span style="color:#954121">as</span><span> ISetLogs)
</span>    store = s
<span>    storeSwapListeners.forEach(</span><span class="hljs-function" style="color:#00f">fn</span><span class="hljs-function"> =&gt;</span><span> fn(store))
</span>  }
<!-- -->  }
<!-- -->  
</code></pre><p>The setStore function is in the same module as the reporter store.  There are two reasons for setStore.</p><p>The first is to provide the global cli reporter log state to the local reporter log state that is used when using the reporter in build/develop.  Given that the main store has the local reporter reducer, when the <code>Actions.SetLogs</code>action is dispatched on the main store the logs slice will be <a href="https://github.com/gatsbyjs/gatsby/blob/a1f35ca37aed1b076f057f1522b56b75a3bdf223/packages/gatsby-cli/src/reporter/redux/reducers/logs.ts#L98" rel="noreferrer" target="_blank"></a> to the log state containing any logging performed by the global cli reporter.</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code class="language-typescript" style="white-space:pre"><span>
</span><span></span><span style="color:#954121">export</span><span> </span><span style="color:#954121">const</span><span> reducer = (
</span>  state: IGatsbyCLIState = {
<span>    </span><span class="hljs-attr">messages</span><span>: [],
</span><span>    </span><span class="hljs-attr">activities</span><span>: {},
</span><span>    </span><span class="hljs-attr">status</span><span>: </span><span style="color:#219161">``</span><span>,
</span>  },
<span>  </span><span class="hljs-attr">action</span><span>: ActionsUnion | ISetLogs
</span><span>): </span><span class="hljs-function" style="color:#00f">IGatsbyCLIState</span><span class="hljs-function"> =&gt;</span><span> {
</span><span>  </span><span style="color:#954121">switch</span><span> (action.type) {
</span><span>    </span><span style="color:#408080;font-style:italic">// and other case statements</span><span>
</span><span>    </span><span style="color:#954121">case</span><span> Actions.SetLogs: {
</span><span>      </span><span style="color:#954121">return</span><span> action.payload
</span>    }
<!-- -->  }
<!-- -->
<span>  </span><span style="color:#954121">return</span><span> state
</span>}
<!-- -->  
</code></pre><p>Secondly, when the global cli reporter invokes actions and dispatch is called the local store is dispatched to.</p><p>The local reporter store is what provides state for logging to the cli during build even though the main store will also contain this state and the state from global cli reporting.</p><p>The main store gets persisted between &quot;builds&quot; in the .cache/redux folder but it is not the full state that is saved.</p><table><thead><th>Reducer</th><th>Persisted</th></thead><tbody><tr><td>definitionsReducer as definitions</td><td></td></tr><tr><td>programReducer as program</td><td></td></tr><tr><td>nodesReducer as nodes</td><td>Yes</td></tr><tr><td>nodesByTypeReducer as nodesByType</td><td></td></tr><tr><td>resolvedNodesCacheReducer as resolvedNodesCache</td><td></td></tr><tr><td>nodesTouchedReducer as nodesTouched</td><td></td></tr><tr><td>lastActionReducer as lastAction</td><td></td></tr><tr><td>flattenedPluginsReducer as flattenedPlugins</td><td></td></tr><tr><td>configReducer as config</td><td></td></tr><tr><td>schemaReducer as schema</td><td></td></tr><tr><td>pagesReducer as pages</td><td>yes</td></tr><tr><td>visitedPagesReducer as visitedPages</td><td></td></tr><tr><td>statusReducer as status</td><td>Yes</td></tr><tr><td>componentsReducer as components</td><td>Yes</td></tr><tr><td>staticQueryComponentsReducer as staticQueryComponents</td><td>Yes</td></tr><tr><td>jobsReducer as jobs</td><td></td></tr><tr><td>jobsV2Reducer as jobsV2</td><td>Yes</td></tr><tr><td>webpackReducer as webpack</td><td></td></tr><tr><td>webpackCompilationHashReducer as webpackCompilationHash</td><td>Yes</td></tr><tr><td>redirectsReducer as redirects</td><td></td></tr><tr><td>babelrcReducer as babelrc</td><td></td></tr><tr><td>schemaCustomizationReducer as schemaCustomization</td><td></td></tr><tr><td>logReducer as logs</td><td></td></tr><tr><td>inferenceMetadataReducer as inferenceMetadata</td><td></td></tr><tr><td>pageDataStatsReducer as pageDataStats</td><td>Yes</td></tr><tr><td>pendingPageDataWritesReducer as pendingPageDataWrites</td><td>Yes</td></tr><tr><td>staticQueriesByTemplateReducer as staticQueriesByTemplate</td><td>Yes</td></tr><tr><td>queriesReducer as queries</td><td>Yes</td></tr><tr><td>htmlReducer as html</td><td>Yes</td></tr><tr><td>functionsReducer as functions</td><td></td></tr><tr><td>nodeManifestReducer as nodeManifests</td><td></td></tr></tbody></table><p>In develop saveDbState is used in state machines.  In build db.saveState is invoked 3 times</p><p>The store is available to gatsby node apis but with the disclaimer <cite>Internal redux state used for application state. Do not use, unless you absolutely must. Store is considered a private API and can change with any version.</cite>.  This is odd given that there is no corresponding getPluginStatus and the only way to access is to use the store ! <code>store.getstate().status.plugins.[pluginname]</code></p><p>As mentioned ..... getNode should be used instead of using the store due to the experimental LMDB data store.</p><h2>How plugins can use the store and cache</h2><p>The node api has access to the store, cache and getCache fields.  The cache is the result of calling getCache for the current plugin but<cite>this should only be used by plugins that accept subplugins.</cite>.  The cache should not be used in onPreInit as there may be no cache at this point. As such a dummy cache is provided that throws.  The store is immediately available as it is set up as soon as redux is required ( build.js requires build-html which requires redux).  The store will be <a href="https://github.com/gatsbyjs/gatsby/blob/fc84b66b7329e8377d39c3910ef8e406738060d6/packages/gatsby/src/redux/index.ts#L85" rel="noreferrer" target="_blank">re-created from the cache</a>.  If the cache files do not exist the try catch will return <a href="https://github.com/gatsbyjs/gatsby/blob/fc84b66b7329e8377d39c3910ef8e406738060d6/packages/gatsby/src/redux/index.ts#L55" rel="noreferrer" target="_blank">an empty state</a>.</p><p>The redux cache is store in 3 parts. Nodes and pages are chunked in .cache/redux/redux.node.state_<i>chunkNumber</i> and .cache/redux/redux.page.state_<i>pageNumber</i> respectively and the rest are within .cache/redux/redux.rest.state.  This is not entirely true when using experimental Lmdb as this stores the nodes in .caches/data/datastore/data.mdb and the redux file will still be persisted.</p><p>The cache directory is initialized via build.js ( command ) <span>=&gt;</span> bootstrap <span>=&gt;</span> services.initialize.  Here we can see that <a href="https://github.com/gatsbyjs/gatsby/blob/fc84b66b7329e8377d39c3910ef8e406738060d6/packages/gatsby/src/services/initialize.ts#L209" rel="noreferrer" target="_blank">onPreInit</a> is called before the <a href="https://github.com/gatsbyjs/gatsby/blob/fc84b66b7329e8377d39c3910ef8e406738060d6/packages/gatsby/src/services/initialize.ts#L423" rel="noreferrer" target="_blank">cache directory is ensured</a> which is prior to<a href="https://github.com/gatsbyjs/gatsby/blob/fc84b66b7329e8377d39c3910ef8e406738060d6/packages/gatsby/src/services/initialize.ts#L430" rel="noreferrer" target="_blank">onPluginInit (v4)</a> and <a href="https://github.com/gatsbyjs/gatsby/blob/fc84b66b7329e8377d39c3910ef8e406738060d6/packages/gatsby/src/services/initialize.ts#L434" rel="noreferrer" target="_blank">unstable_onPluginInit</a>.  Hence safe to use there.</p><p>There are <a href="https://github.com/gatsbyjs/gatsby/blob/master/packages/gatsby/src/utils/get-cache.ts#L6" rel="noreferrer" target="_blank">two possible caches</a>.  Lmdb if you set the experimental flag.  The <a href="https://github.com/gatsbyjs/gatsby/blob/a1f35ca37aed1b076f057f1522b56b75a3bdf223/packages/gatsby/index.d.ts#L1312" rel="noreferrer" target="_blank">interface</a> is the same for both. ( The regular cache does permit expiration with a third argument to the <a href="https://github.com/gatsbyjs/gatsby/blob/fc84b66b7329e8377d39c3910ef8e406738060d6/packages/gatsby/src/utils/cache.ts#L77" rel="noreferrer" target="_blank">set method</a> if you were so inclined. ).  Both (<b>plugin</b>) caches</p><p>The regular cache is a multi cache of memory and file system ( in json format ).  When <code>set</code> it goes in both and when <code>get</code> it comes from the first.  The memory cache will hold 250 items and will evict the first added to accomodate additional.  The store creates a folder in .cache/caches for each plugin ( <code>getCache(<i>name</i></code>).  For every call to set a json file is created named diskstore-<i>keyhash</i>.json</p><p>The lmdb cache is stored in .cache/caches-lmdb/data.mdb.  For the lmdb cache and lmdb datastore maxDbs is 200 which I suppose could be a problem if you had that many plugins.  Despite not saving anything to .cache/caches when using lmdb a <i>named folder</i> is created for every getCache(<i>name</i>) so you can see what plugins have cached data.</p><p>The action setPluginStatus which, given that it uses the redux store, can be used in onPreInit.  This is the <a href="https://github.com/gatsbyjs/gatsby/blob/fc84b66b7329e8377d39c3910ef8e406738060d6/packages/gatsby/src/redux/reducers/status.ts#L39" rel="noreferrer" target="_blank">status slice</a>.  The object arg will be merged into any previously set status.</p><p>To remove the .cache directory ( and the public directory ) you can use the command <code>gatsby clean</code>.</p></main></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/deepdive/gatsby/store-cache/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-fd5502421d629d1c910a.js"],"app":["/app-0d7647bce7fd84d9a89d.js"],"component---src-pages-404-js":["/component---src-pages-404-js-b2cc411f045347620867.js"],"component---src-pages-deepdive-cli-js":["/component---src-pages-deepdive-cli-js-5741b91b6777519321aa.js"],"component---src-pages-deepdive-gatsby-apicalls-node-build-js":["/component---src-pages-deepdive-gatsby-apicalls-node-build-js-e5e4b56ca87f5d0bb4a6.js"],"component---src-pages-deepdive-gatsby-apicalls-node-creating-nodes-js":["/component---src-pages-deepdive-gatsby-apicalls-node-creating-nodes-js-b79bfcf2bc434d369d1d.js"],"component---src-pages-deepdive-gatsby-apicalls-node-creating-pages-js":["/component---src-pages-deepdive-gatsby-apicalls-node-creating-pages-js-2dfb533b04b8d55e2216.js"],"component---src-pages-deepdive-gatsby-apicalls-node-index-js":["/component---src-pages-deepdive-gatsby-apicalls-node-index-js-25bcd576de4091c3fafe.js"],"component---src-pages-deepdive-gatsby-apicalls-node-nodes-js":["/component---src-pages-deepdive-gatsby-apicalls-node-nodes-js-78ea86f5dc156d3e163d.js"],"component---src-pages-deepdive-gatsby-apicalls-node-pages-js":["/component---src-pages-deepdive-gatsby-apicalls-node-pages-js-429f58648a20d576e77a.js"],"component---src-pages-deepdive-gatsby-debugging-js":["/component---src-pages-deepdive-gatsby-debugging-js-d5ef0d64a47152f2106d.js"],"component---src-pages-deepdive-gatsby-index-js":["/component---src-pages-deepdive-gatsby-index-js-e7b7db76472828d679e8.js"],"component---src-pages-deepdive-gatsby-plugins-js":["/component---src-pages-deepdive-gatsby-plugins-js-de83669c3a27e3acecd1.js"],"component---src-pages-deepdive-gatsby-prefixes-js":["/component---src-pages-deepdive-gatsby-prefixes-js-21b67aa42668832d6c37.js"],"component---src-pages-deepdive-gatsby-reporter-js":["/component---src-pages-deepdive-gatsby-reporter-js-75b6f100488f1bc790b2.js"],"component---src-pages-deepdive-gatsby-store-cache-js":["/component---src-pages-deepdive-gatsby-store-cache-js-dbe7ef065c5348ef6a7b.js"],"component---src-pages-deepdive-mdxplugin-js":["/component---src-pages-deepdive-mdxplugin-js-ff1e0bd02065d047b9bb.js"],"component---src-pages-index-js":["/component---src-pages-index-js-c65a6b8256ce98a6a1f4.js"],"component---src-pages-match-js":["/component---src-pages-match-js-1cabc63be828d8401b63.js"],"component---src-pages-mdx-mdx":["/component---src-pages-mdx-mdx-a0916c906b3d8eac84ca.js"],"component---src-templates-dynamic-page-template-js":["/component---src-templates-dynamic-page-template-js-5b35e311d2f48f0b9bdd.js"]};/*]]>*/</script><script src="/DemoGatsby/polyfill-fd5502421d629d1c910a.js" nomodule=""></script><script src="/DemoGatsby/component---src-pages-deepdive-gatsby-store-cache-js-dbe7ef065c5348ef6a7b.js" async=""></script><script src="/DemoGatsby/3710c607fb7064fe4fae57fa2457800b9099a42b-828b874f09212eef7e62.js" async=""></script><script src="/DemoGatsby/app-0d7647bce7fd84d9a89d.js" async=""></script><script src="/DemoGatsby/framework-33b76a5d919ecf8a8684.js" async=""></script><script src="/DemoGatsby/webpack-runtime-92ea2c36fbfb344b443f.js" async=""></script></body></html>